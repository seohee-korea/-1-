<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>1í˜¸ì„  ë„ì°© ì•ŒëŒ (50m)</title>
  <style>
    body { font-family: system-ui, -apple-system, sans-serif; margin: 18px; }
    .row { margin: 12px 0; }
    select, button { font-size: 16px; padding: 10px 12px; }
    #status { white-space: pre-line; padding: 12px; background: #f6f6f6; border-radius: 10px; }
    small { color: #555; }
  </style>
</head>
<body>
  <h2>1í˜¸ì„  ë„ì°© ì•ŒëŒ (50m)</h2>

  <div class="row">
    <label for="stationSelect">ëª©ì ì§€(1í˜¸ì„  ì „êµ¬ê°„): </label>
    <select id="stationSelect" disabled>
      <option>ì—­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘â€¦</option>
    </select>
    <div><small id="loadInfo"></small></div>
  </div>

  <div class="row">
    <button id="startBtn" disabled>ì‹œì‘</button>
    <button id="stopBtn" disabled>ì¤‘ì§€</button>
    <button id="muteBtn" disabled>ì•ŒëŒ ë„ê¸°(ì†Œë¦¬ë§Œ)</button>
  </div>

  <div id="status">ëŒ€ê¸° ì¤‘â€¦</div>

  <!-- ì•ŒëŒ ìŒì›(ì›í•˜ì‹œë©´ ë‹¤ë¥¸ ogg/mp3ë¡œ ë°”ê¾¸ì…”ë„ ë©ë‹ˆë‹¤) -->
  <audio id="alarmAudio" preload="auto" loop
    src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
  // âœ… ì—­/ì¢Œí‘œ ë°ì´í„°(ìˆ˜ë„ê¶Œ ì§€í•˜ì²  ì •ë¦¬ë³¸)ì—ì„œ 1í˜¸ì„ ë§Œ í•„í„°ë§
  // ì¶œì²˜ ì†Œê°œ ê¸€(ë°ì´í„° ì„¤ëª…)ê³¼ raw JSON ë§í¬:
  // https://minisp.tistory.com/20
  // https://raw.githubusercontent.com/sudo-happy/data-archive/main/metro/station/data-metro-station-1.0.0.json
  const STATION_DATA_URL =
    "https://raw.githubusercontent.com/sudo-happy/data-archive/main/metro/station/data-metro-station-1.0.0.json";

  const RANGE_M = 50;

  const $select = document.getElementById("stationSelect");
  const $start = document.getElementById("startBtn");
  const $stop  = document.getElementById("stopBtn");
  const $mute  = document.getElementById("muteBtn");
  const $status = document.getElementById("status");
  const $alarm = document.getElementById("alarmAudio");
  const $loadInfo = document.getElementById("loadInfo");

  let watchId = null;
  let triggered = false;
  let wakeLock = null;

  function haversineMeters(lat1, lon1, lat2, lon2) {
    const R = 6371000;
    const toRad = (d) => d * Math.PI / 180;
    const dLat = toRad(lat2 - lat1);
    const dLon = toRad(lon2 - lon1);
    const a =
      Math.sin(dLat/2) ** 2 +
      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2) ** 2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function requestWakeLock() {
    try {
      if ("wakeLock" in navigator) {
        wakeLock = await navigator.wakeLock.request("screen");
      }
    } catch (_) {}
  }

  function releaseWakeLock() {
    if (wakeLock) {
      try { wakeLock.release(); } catch (_) {}
      wakeLock = null;
    }
  }

  async function loadStations() {
    try {
      const res = await fetch(STATION_DATA_URL, { cache: "no-store" });
      if (!res.ok) throw new Error("ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨");
      const all = await res.json();

      // ë°ì´í„° í•„ë“œ ì˜ˆ: { line:"1í˜¸ì„ ", name:"ì‹ ë„ë¦¼", lat:..., lng:... }
      const line1 = all
        .filter(s => (s.line === "1í˜¸ì„ ") && Number.isFinite(s.lat) && Number.isFinite(s.lng));

      // ë³´ê¸° ì¢‹ê²Œ ê°€ë‚˜ë‹¤ ì •ë ¬ (ì›í•˜ì‹œë©´ 'ì—­ìˆœì„œ' ì •ë ¬ë„ ë”°ë¡œ ë§ì¶°ë“œë¦´ ìˆ˜ ìˆì–´ìš”)
      const collator = new Intl.Collator("ko");
      line1.sort((a,b) => collator.compare(a.name, b.name));

      $select.innerHTML = "";
      for (const s of line1) {
        const opt = document.createElement("option");
        // í˜¹ì‹œ ë™ëª…ì—­ì´ ìƒê²¨ë„ êµ¬ë¶„ ê°€ëŠ¥í•˜ê²Œ ì½”ë“œë„ ê°™ì´ ë³´ê´€
        opt.value = JSON.stringify({ name: s.name, lat: s.lat, lon: s.lng, code: s.fr_code ?? s.station_cd ?? "" });
        opt.textContent = s.code ? `${s.name} (${s.code})` : s.name;
        $select.appendChild(opt);
      }

      $select.disabled = false;
      $start.disabled = false;
      $loadInfo.textContent = `1í˜¸ì„  ì—­ ${line1.length}ê°œ ë¡œë“œ ì™„ë£Œ (ì „êµ¬ê°„)`;
      $status.textContent = "ëª©ì ì§€ë¥¼ ì„ íƒí•˜ê³  ì‹œì‘ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";

    } catch (e) {
      $status.textContent =
        "ì—­ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n" +
        "1) ì¸í„°ë„· ì—°ê²° í™•ì¸\n2) GitHub Pages/Netlify ê°™ì€ HTTPS í™˜ê²½ì—ì„œ ì‹¤í–‰ ê¶Œì¥\n" +
        `ì—ëŸ¬: ${e.message}`;
      $loadInfo.textContent = "";
    }
  }

  async function primeAudioPermission() {
    // ëª¨ë°”ì¼(íŠ¹íˆ iOS)ì—ì„œ 'ì‚¬ìš©ì ì œìŠ¤ì²˜'ê°€ ìˆì–´ì•¼ play ê°€ëŠ¥ â†’ ì‹œì‘ ë²„íŠ¼ í´ë¦­ ì‹œ ë¯¸ë¦¬ ì¤€ë¹„
    try {
      $alarm.volume = 1.0;
      await $alarm.play();
      $alarm.pause();
      $alarm.currentTime = 0;
    } catch (_) {}
  }

  async function start() {
    triggered = false;

    if (!navigator.geolocation) {
      alert("ì´ ë¸Œë¼ìš°ì €ëŠ” ìœ„ì¹˜ ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
      return;
    }

    await primeAudioPermission();
    await requestWakeLock();

    const target = JSON.parse($select.value);
    const tLat = target.lat;
    const tLon = target.lon;
    const tName = target.name;

    $status.textContent = `ì¶”ì  ì‹œì‘\nëª©ì ì§€: ${tName}\në²”ìœ„: ${RANGE_M}m`;
    $start.disabled = true;
    $stop.disabled = false;
    $mute.disabled = true;
    $select.disabled = true;

    watchId = navigator.geolocation.watchPosition(
      async (pos) => {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const acc = pos.coords.accuracy;
        const d = haversineMeters(lat, lon, tLat, tLon);

        $status.textContent =
          `ëª©ì ì§€: ${tName}\n` +
          `í˜„ì¬ ì •í™•ë„: ì•½ ${Math.round(acc)}m\n` +
          `ê±°ë¦¬: ì•½ ${Math.round(d)}m / ${RANGE_M}m\n` +
          `ì‹œê°„: ${new Date().toLocaleTimeString()}`;

        // ì •í™•ë„ê°€ ë„ˆë¬´ ë‚˜ì  ë•Œ(ì˜ˆ: ì§€í•˜) ì˜¤íƒ ì¤„ì´ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì¡°ê±´ì„ ì¼œì„¸ìš”:
        // if (acc > 80) return;

        if (!triggered && d <= RANGE_M) {
          triggered = true;

          try { navigator.vibrate?.([300, 200, 300, 200, 600]); } catch (_) {}
          try { await $alarm.play(); } catch (_) {}

          $mute.disabled = false;

          alert(`ğŸš¨ ${tName} ë„ì°©! (ë°˜ê²½ ${RANGE_M}m ì´ë‚´)`);
        }
      },
      (err) => {
        alert("ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ ì£¼ì„¸ìš”. (ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ìœ„ì¹˜ ON)");
        stop();
      },
      { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 }
    );
  }

  function stop() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    triggered = false;

    $alarm.pause();
    $alarm.currentTime = 0;

    releaseWakeLock();

    $status.textContent = "ì¤‘ì§€ë¨";
    $start.disabled = false;
    $stop.disabled = true;
    $mute.disabled = true;
    $select.disabled = false;
  }

  function muteOnly() {
    $alarm.pause();
    $alarm.currentTime = 0;
    $mute.disabled = true;
    // ì¶”ì ì€ ê³„ì† ìœ ì§€, ì¬ì•Œë¦¼ì€ ë§‰ì•„ë‘ (triggered=true ìœ ì§€)
  }

  document.getElementById("startBtn").addEventListener("click", start);
  document.getElementById("stopBtn").addEventListener("click", stop);
  document.getElementById("muteBtn").addEventListener("click", muteOnly);

  loadStations();
</script>
</body>
</html>